{% extends 'base.html' %}

{% block title%}
    {{stop}}
{% endblock%}

{% block content%} 

<div>
<form method="post" id = "formadd">
    {% csrf_token %}
    {{ form }}
    <button id = "subbtn" type="submit">submit</button>
</form>
</div>

<!-- the area div that is used to hold the content after refrensh -->
<div id = "area"></div>  

<div>
    <script src="http://cdn.static.runoob.com/libs/jquery/1.10.2/jquery.min.js"></script>  
    <script>
        
        $('#formadd').submit(function(){
                info = {
                csrfmiddlewaretoken: '{{ csrf_token }}', 
                stop :  $('#formadd').serialize(),
                };
               
                $.ajax({
                    type:"POST",
                    url: "http://127.0.0.1:8000/real_info/", 
                    cache: false,
                    dataType: "html",
                    headers:{'Content-Type':"application/json"} ,
                    data:info,
                    success: function(result, statues, xml){
                        result = JSON.parse(result);
                        // console.log(result); 
                        var real_info = "Time Table" +"<br>";
                        for (var i =0; i< result["results"].length; i++){
                            real_info += result["results"][i]["route"]+"   "+result["results"][i]["arrivaldatetime"] +"<br>";
                        }
                        $("#area").html(real_info);             
                    },
                    error: function(){
                        alert("false");
                    }
                });

                // 
                
                // 这都是原来没有的，因为不知道怎么取得form的内容，只能现在这里写
                var stop_id_arr = $('#formadd').serialize();
                var stop_id = stop_id_arr.split("=")[2];
                stopKeys = Object.keys(stopdata);
                // console.log(stopKeys);
                // console.log(stop_id_arr.split("=")[2]);

                var marker;
                var markers = [];
                var stopKey;
                var stop_idd; //在for循环里相匹配的
                for (i=0;i<stopKeys.length;i++){
                    stopKey = stopKeys[i]
                    stop_idd = stopdata[stopKey]["stopno"];
                    
                    if (stop_idd == stop_id){
                        var stationsInfo =  "Stop_number:<h5>"+stop_idd+"<h5>";
                            marker = new google.maps.Marker({
                                position: new google.maps.LatLng(
                                    stopdata[stopKey]['latitude'], 
                                    stopdata[stopKey]['longitude']),
                                map: map
                            });

                            marker.setVisible(false);
                            map.setZoom(15);
                            map.panTo(marker.position);
                            marker.setMap(map);

                            

                            var infowindow  = new google.maps.InfoWindow({
                                    content: ""
                                });
                            var pre = false;

                            document.getElementById("subbtn").addEventListener("click", function(){
                                pre.close();
                            });

                            google.maps.event.addListener(marker,'click', (function(marker,stationsInfo,infowindow){
                                pre = infowindow;
                                pre.setContent(stationsInfo);
                                pre.open(map, marker);
                                

                                }) (marker,stationsInfo,infowindow));
                            }
                        }
                return false;
            });
    </script>
</div>


<script src="jquery-3.5.1.min.js"></script>

    <script type="text/javascript">
        $(document).ready(function() {
        $.ajax({
            method: 'POST',
            url: '/path/to/your/view/',
            data: {'yourJavaScriptArrayKey': yourJavaScriptArray},
            success: function (data) {
                //this gets called when server returns an OK response
                alert("it worked!");
            },
            error: function (data) {
                alert("it didnt work");
            }
        });
    });
    </script>

    <script>
        var stopdata = '{{stopdata|safe}}';
        stopdata = JSON.parse(stopdata);
        // console.log(stopdata)
    </script>

    <script src="https://unpkg.com/@google/markerclustererplus@4.0.1/dist/markerclustererplus.min.js"></script>
    </script>
{%endblock%}